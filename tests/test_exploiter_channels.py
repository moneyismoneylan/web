import types
import asyncio
import base64
from sqli_hunter.exploiter import Exploiter


def test_low_and_slow_channels():
    exploiter = Exploiter(types.SimpleNamespace())
    vuln = {
        'url': 'http://example.com',
        'method': 'GET',
        'parameter': 'id',
        'simulated_responses': {
            'doh': ['x'],
            'h2': ['a', 'b'],
            'quic': ['y'],
            'ws': ['c', 'd'],
        }
    }

    async def run():
        res_doh = await exploiter.extract_data_doh(None, vuln, 'k0')
        res_h2 = await exploiter.extract_data_h2(None, vuln, 'k1')
        res_quic = await exploiter.extract_data_quic(None, vuln, 'k2')
        res_ws = await exploiter.extract_data_ws(None, vuln, 'k3')
        decode = lambda s: base64.b64decode(s).decode()
        assert decode(res_doh['data']) == 'x'
        assert decode(res_h2['data']) == 'ab'
        assert decode(res_quic['data']) == 'y'
        assert decode(res_ws['data']) == 'cd'
        auto = await exploiter.auto_extract(None, vuln, 'k4')
        assert decode(auto['data']) in ('x', 'ab', 'y', 'cd')

    asyncio.run(run())
